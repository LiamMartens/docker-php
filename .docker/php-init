#!/bin/bash

# get the container IP address and export it as an environment variable
export PHP_TCP=$(awk 'END{print $1}' /etc/hosts)

# function to check php.ini config and bak
checkPhpIni() {
	if [[ $(cat /etc/php7/php.ini) =~ "^\s*$" ]]; then
		mv /etc/php7/php.ini.bak /etc/php7/php.ini
	else
		rm /etc/php7/php.ini.bak
	fi
}

# function to check fpm www pool and bak
checkPhpPool() {
	if [[ $(cat /etc/php7/php-fpm.d/www.conf) =~ "^\s*$" ]]; then
		mv /etc/php7/php-fpm.d/www.conf.bak /etc/php7/php-fpm.d/www.conf
	else
		rm /etc/php7/php-fpm.d/www.conf.bak
	fi
}

#
# set php variables
#
# PHP_MEMORY_LIMIT -> memory_limit
# PHP_ZLIB__OUTPUT_COMPRESSION -> zlib.output_compression
#
WWWVARS='[www]'
ENV_VARS=($(env))
for VAR in "${ENV_VARS[@]}"; do
	VAR_NAME=$(echo $VAR | cut -d'=' -f 1)
	VAR_VALUE=$(echo $VAR | cut -d'=' -f 2)
	if [[ $VAR_VALUE != "" ]]; then
		if [[ "$VAR_NAME" =~ "PHP_"* ]] && [[ "$VAR_NAME" != "PHP_PORT" ]]; then
			PHP_SETTING=$(echo $VAR_NAME | cut -d'_' -f 2-)
			PHP_SETTING=$(echo $PHP_SETTING | awk '{print tolower($0)}')
			PHP_SETTING=$(echo $PHP_SETTING | perl -pe "s/__/./")
			perl -p -i.bak -e "s/^$PHP_SETTING\s*=\s*.*/$PHP_SETTING = $VAR_VALUE/gi" /etc/php7/php.ini
			checkPhpIni
		else
			WWWVARS="$WWWVARS"$'\n'"env[$VAR_NAME]=$VAR_VALUE"
		fi
	fi
done
echo "$WWWVARS" > /etc/php7/php-fpm.d/env.conf

# set php listen port
perl -p -i.bak -e "s/listen\s*=\s*(.+):.+/listen = $PHP_TCP:$PHP_PORT/gi" /etc/php7/php-fpm.d/www.conf
checkPhpPool

# set timezone
perl -p -i.bak -e "s/;*date.timezone\s*=.*/date.timezone = $TIMEZONE/gi" /etc/php7/php.ini
checkPhpIni